
# Apache NiFi Secure Standalone Setup

![Apache NiFi Secure Standalone Setup](https://github.com/InsightByte/ApacheNifi/blob/main/NiFi-Secured-Single-Instance/assets/NiFi-Secure.png)

![](https://i.imgur.com/waxVImv.png)
#### ðŸ’¬ If you have Questions or wanna have a chat - Join Me on Discord at:
[Apache NiFi Topics Q&A](https://discord.gg/qymAvnZqmQ)

[Data Engineering Topics Q&A](https://discord.gg/YykpUT5Wt2)

[Data Engineering  Compass Q&A](https://discord.gg/XR3JqUrA74)

![](https://i.imgur.com/waxVImv.png)

##### Find the video version of this article at [Apache NiFi Secure Standalone Setup](https://youtu.be/j-JXo3xPxOk)
#### Generate Keys and Certificates

```
/opt/nifi-toolkit/bin/tls-toolkit.sh standalone -n 'localhost' -B ClientPassword -C 'CN=InsightByte,OU=DEMO' -O -o /opt/nifi-prd-3/certs
```
**-n** hostname accessing NiFi.

**-B** Password for client certificate.

**-C** Generate client certificate suitable for use in browser with specified DN

**-o** The directory to output keystores, truststore, config files.


#### This will generate a truststore, keystore and the nifi.properties files along with the client certificates.
```
certs/
â”œâ”€â”€ CN=InsightByte_OU=NIFI.p12
â”œâ”€â”€ CN=InsightByte_OU=NIFI.password
â”œâ”€â”€ localhost
â”‚   â”œâ”€â”€ keystore.jks
â”‚   â”œâ”€â”€ nifi.properties
â”‚   â””â”€â”€ truststore.jks
â”œâ”€â”€ nifi-cert.pem
â””â”€â”€ nifi-key.key
```


#### Edit the nifi.properties 
Add the full path to your truststore.jks and keystore.jks and then copy the new nifi.properties into your nifi conf directory

#### Edit the nifi.security.user.authorizer and set it to:
```
nifi.security.user.authorizer=managed-authorizer
```

#### Before you start your instance make sure you edit your nifi.properties file and add the nifi.sensitive.props.key
See more at [NiFi Official Documentation](https://nifi.apache.org/docs/nifi-docs/html/administration-guide.html#updating-the-sensitive-properties-key)

#### Update Security Properties Key 
```
/opt/nifi-prd-3/bin/nifi.sh set-sensitive-properties-key asdefc123456
NiFi home: /opt/nifi-prd-3
Bootstrap Config File: /opt/nifi-prd-3/conf/bootstrap.conf
Flow Configuration Processed [./conf/flow.xml.gz]
Flow Configuration Processed [./conf/flow.json.gz]
NiFi Properties Processed [/opt/nifi-prd-3/conf/nifi.properties]
```



#### Import the .p12 certificate into your browser

#### Provide the password you used when you generated the certificate


#### Edit your authorizers.xml to look like this.
```
<authorizers>
     <userGroupProvider>
          <identifier>file-user-group-provider</identifier>
          <class>org.apache.nifi.authorization.FileUserGroupProvider</class>
          <property name="Users File">./conf/users.xml</property>
          <property name="Legacy Authorized Users File"></property>
          <property name="Initial User Identity 1">CN=InsightByte, OU=DEMO</property>
     </userGroupProvider>

     <accessPolicyProvider>
          <identifier>file-access-policy-provider</identifier>
          <class>org.apache.nifi.authorization.FileAccessPolicyProvider</class>
          <property name="User Group Provider">file-user-group-provider</property>
          <property name="Authorizations File">./conf/authorizations.xml</property>
          <property name="Initial Admin Identity">CN=InsightByte, OU=DEMO</property>
          <property name="Legacy Authorized Users File"></property>
          <property name="Node Identity 1">CN=InsightByte, OU=DEMO</property>
          <property name="Node Group"></property>
     </accessPolicyProvider>

     <authorizer>
          <identifier>managed-authorizer</identifier>
          <class>org.apache.nifi.authorization.StandardManagedAuthorizer</class>
          <property name="Access Policy Provider">file-access-policy-provider</property>
     </authorizer>
</authorizers>
```

#### Comment
```
    <!-- <authorizer>
        <identifier>single-user-authorizer</identifier>
        <class>org.apache.nifi.authorization.single.user.SingleUserAuthorizer</class>
    </authorizer> -->
```


#### Remove the users.xml authorizations.xml files from your ./conf/ folder
```
cd ./conf/
rm -rf users.xml authorizations.xml
```

- On NiFi startup the **file-user-group-provider** will create the **users.xml** file only if it does NOT already exist and seed it with all four configured **Initial User Identity** strings.
- On NIFi Startup the **file-access-policy-provider** will create the **authorizations.xml** file only if it does NOT already exist and seed it with relevant policies needed initially for your admin user and your nodes based off the UUIDs create for each user identity generated by the first provider.

#### Start NiFi
```
./bin/nifi.sh start
```
You should be able to open the https://localhost:9443/nifi now.

#### Debug Access Issues
Review **nifi-user.log** to debug issues with access.
